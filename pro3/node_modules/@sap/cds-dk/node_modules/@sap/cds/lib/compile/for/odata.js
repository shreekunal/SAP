const compile = require ('../cdsc')
const cds = require('../../index')
const TRACE = cds.debug('trace')

module.exports = function cds_compile_for_odata (csn,_o) {
  if ('_4odata' in csn) return csn._4odata
  TRACE?.time('cds.compile 4odata'.padEnd(22))
  let o = compile._options.for.odata(_o) //> required to inspect .sql_mapping below
  let dsn = compile.for.odata (csn,o)
  if (o.sql_mapping) dsn['@sql_mapping'] = o.sql_mapping //> compat4 old Java stack

  if (cds.env.fiori.direct_crud) {
    const DRAFT_NEW = 'draftNew'
    for (const each in dsn.definitions) {
      const def = dsn.definitions[each]
      if (!def['@Common.DraftRoot.NewAction'] && def['@Common.DraftRoot.ActivationAction']) {
        const srvName = Object.keys(dsn.definitions)
          .filter(k => dsn.definitions[k].kind === 'service')
          .find(k => each.startsWith(`${k}.`))
        def['@Common.DraftRoot.NewAction'] = `${srvName}.${DRAFT_NEW}`
        const params = { in: { items: { type: '$self' } } }
        // for UI pop-up asking for values for non-UUID keys
        Object.keys(def.elements)
          .filter(k => k !== 'IsActiveEntity' && def.elements[k].key && def.elements[k].type !== 'cds.UUID')
          .forEach(k => (params[k] = { type: def.elements[k].type }))
        def.actions[DRAFT_NEW] = { kind: 'action', params, returns: { type: each } }
      }
    }
  }

  Object.defineProperty (csn, '_4odata', {value:dsn})
  Object.defineProperty (dsn, '_4odata', {value:dsn})
  TRACE?.timeEnd('cds.compile 4odata'.padEnd(22))
  return dsn
}
