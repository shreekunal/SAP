// @ts-check
const cds = require('../cds')
const DEBUG = cds.debug('cli|build')

/** @typedef {typeof import('./plugin')} BuildPlugin */

module.exports = new (class Plugins {

    /** @type {Map<string, BuildPlugin>} */
    #plugins = new Map()

    get plugins() {
        return this.#plugins
    }

    constructor() {
        this.#registerDefaults()
    }

    /**
     * @param {string} id - unique ID of the plugin
     * @param {BuildPlugin} plugin - build plugin implementation
     */
    register(id, plugin) {
        if (!id || !plugin) {
            throw new Error(`Invalid parameter passed, build plugin id: ${id}`)
        }
        if (this.#plugins.has(id)) {
            throw new Error(`CDS build plugin ${id} already registered`)
        }
        DEBUG?.(`registering build plugin ${id}`)
        this.#plugins.set(id, plugin)
    }

    #registerDefaults() {
        this.register('helm', require('./plugins/helm'))
    }
})
