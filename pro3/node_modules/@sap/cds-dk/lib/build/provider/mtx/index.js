const fs = require('fs')
const path = require('path')
const cds = require('../../../cds')
const EdmxBuildPlugin = require('../edmxBuildPlugin')
const ResourcesTarBuilder = require('./resourcesTarBuilder')
const { FOLDER_GEN } = require('../../constants')

class MtxBuildPlugin extends EdmxBuildPlugin {
    get priority() {
        // must run after 'hana' build task
        return super.priority - 10
    }

    init() {
        super.init()
    }

    async build() {
        // Only create resources TAR, compiled CSN(s) are created by the Nodejs app build task.
        const dest = cds.env.build.target !== '.' ? this.task.dest : path.join(this.task.dest, FOLDER_GEN)
        const model = await this.model()
        if (!model) {
            return
        }
        return new ResourcesTarBuilder(this).createTar(dest, model)
    }

    async clean() {
        // staging build content is deleted by BuildTaskEngine
        if (cds.env.build.target === '.') {
            // remove 'gen' folder
            return fs.promises.rm(path.join(this.task.dest, FOLDER_GEN), { force: true, recursive: true })
        }
    }
}
module.exports = MtxBuildPlugin
